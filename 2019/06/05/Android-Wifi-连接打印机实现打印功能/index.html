<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="做个不甘于平凡的人，首先要做个平凡的人">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Android Wifi 连接打印机实现打印功能 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> learn by heart， live by heart </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            <i>秦家十月</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-text">Android Wifi 连接打印机实现打印功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#undefined"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#undefined"><span class="toc-text">方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#undefined"><span class="toc-text">权限</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#undefined"><span class="toc-text">打印</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#undefined"><span class="toc-text">总结</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> learn by heart， live by heart </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Android Wifi 连接打印机实现打印功能
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-06-05 14:29:50</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#Android Wifi 打印" title="Android Wifi 打印">Android Wifi 打印</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <h2>Android Wifi 连接打印机实现打印功能</h2>

<h5>前言</h5>

<p>Wifi 连接打印机是除蓝牙连接之外的另一种连接方式。</p>
<p>使用 Wifi 连接打印机之前请确保一下几点：</p>
<blockquote>
<p>打印机可以连接 Wifi 且和你的手机处于同一无线网络下；</p>
</blockquote>
<blockquote>
<p>手机要安装有对饮打印机的驱动，如 HP Print Service, Brother Print Service Plugin 等。</p>
</blockquote>
<blockquote>
<p>Android SDK 版本确保在 4.4 及以上， 因为开发是基于 Android 推出的打印服务 PrintHelper|PrintManager 来实现连接和打印的</p>
</blockquote>
<h5>方式</h5>

<p>PrintHelper 可以打印 Bitmap、 Html、 PDF 等几种格式的文件， 不过大多数情况下， 我们需要打印 word 文档， 所以本文也会介绍一下 word 文档的编辑生成和转化为 html 页面进行打印。</p>
<h5>权限</h5>

<blockquote>
<p>android.permission.INTERNET</p>
</blockquote>
<blockquote>
<p>android.permission.READ__EXTERNAL_STORAGE</p>
</blockquote>
<blockquote>
<p>android.permission.WRITE__EXTERNAL_STORAGE</p>
</blockquote>
<h5>打印</h5>

<blockquote>
<p>打印 Bitmap</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">val bitmap = BitmapFactory.decodeResource(resources, R.drawable.app_image_small)</span><br><span class="line"></span><br><span class="line">val printHelper = PrintHelper(context)</span><br><span class="line">   printHelper.scaleMode = PrintHelper.SCALE_MODE_FIT</span><br><span class="line">   printHelper.printBitmap(&quot;test-print&quot;, bitmap)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>打印 html</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">fun PrintHtml(context: Context, url: String, data: Array&lt;Array&lt;String&gt;&gt;?) &#123;</span><br><span class="line">	var webView: WebView? = WebView(context)</span><br><span class="line">       webView?.settings?.javaScriptEnabled = true</span><br><span class="line">       webView?.webViewClient = object : WebViewClient() &#123;</span><br><span class="line">           override fun onPageFinished(view: WebView?, url: String?) &#123;</span><br><span class="line">               val gson = Gson()</span><br><span class="line">               if (data !== null) &#123;</span><br><span class="line">                   webView?.loadUrl(&quot;javascript:setExcelData($&#123;gson.toJson(data!!)&#125;, $&#123;data!![0].size&#125;)&quot;)</span><br><span class="line">                   webView?.loadUrl(&quot;javascript:generateExcel()&quot;)</span><br><span class="line">               &#125;</span><br><span class="line">               if (Build.VERSION.SDK_INT &gt;= 19) &#123;</span><br><span class="line">                   createWebPrintJob(context, view)</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   Toast.makeText(context, &quot;当前版本号低于 4.4&quot;, Toast.LENGTH_SHORT).show()</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       webView?.loadUrl(url)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@RequiresApi(Build.VERSION_CODES.KITKAT)</span><br><span class="line">   private fun createWebPrintJob(context: Context, view: WebView?) &#123;</span><br><span class="line">       val printManager: PrintManager = context.getSystemService(Context.PRINT_SERVICE) as PrintManager</span><br><span class="line"></span><br><span class="line">       val printDocumentAdapter = view?.createPrintDocumentAdapter()</span><br><span class="line"></span><br><span class="line">       val jobName = &quot;$&#123;R.string.app_name&#125;Document&quot;</span><br><span class="line"></span><br><span class="line">       val printJob = printManager.print(jobName, printDocumentAdapter, PrintAttributes.Builder().build())</span><br><span class="line">   &#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@RequiresApi(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">public class MyPrintPdfAdapter extends PrintDocumentAdapter &#123;</span><br><span class="line">    private String mFilePath;</span><br><span class="line"> </span><br><span class="line">    public MyPrintPdfAdapter(String file) &#123;</span><br><span class="line">        this.mFilePath = file;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @RequiresApi(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">    @Override</span><br><span class="line">    public void onLayout(PrintAttributes oldAttributes, PrintAttributes newAttributes,</span><br><span class="line">                         CancellationSignal cancellationSignal,</span><br><span class="line">                         LayoutResultCallback callback, Bundle extras) &#123;</span><br><span class="line">        if (cancellationSignal.isCanceled()) &#123;</span><br><span class="line">            callback.onLayoutCancelled();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        PrintDocumentInfo info = new PrintDocumentInfo.Builder(&quot;name&quot;)</span><br><span class="line">                .setContentType(PrintDocumentInfo.CONTENT_TYPE_DOCUMENT)</span><br><span class="line">                .build();</span><br><span class="line">        callback.onLayoutFinished(info, true);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @RequiresApi(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">    @Override</span><br><span class="line">    public void onWrite(PageRange[] pages, ParcelFileDescriptor destination,</span><br><span class="line">                        CancellationSignal cancellationSignal,</span><br><span class="line">                        WriteResultCallback callback) &#123;</span><br><span class="line">        InputStream input = null;</span><br><span class="line">        OutputStream output = null;</span><br><span class="line"> </span><br><span class="line">        try &#123;</span><br><span class="line"> </span><br><span class="line">            input = new FileInputStream(mFilePath);</span><br><span class="line">            output = new FileOutputStream(destination.getFileDescriptor());</span><br><span class="line"> </span><br><span class="line">            byte[] buf = new byte[1024];</span><br><span class="line">            int bytesRead;</span><br><span class="line"> </span><br><span class="line">            while ((bytesRead = input.read(buf)) &gt; 0) &#123;</span><br><span class="line">                output.write(buf, 0, bytesRead);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            callback.onWriteFinished(new PageRange[]&#123;PageRange.ALL_PAGES&#125;);</span><br><span class="line"> </span><br><span class="line">        &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                output.close();           </span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            try &#123;</span><br><span class="line">                input.close();                </span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;s</span><br></pre></td></tr></table></figure>
<blockquote>
<p>打印 PDF</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@RequiresApi(Build.VERSION_CODES.KITKAT)</span><br><span class="line">   private fun doPdfPrint(context: Context, filePath: String) &#123;</span><br><span class="line">       var printManager = context.getSystemService(Context.PRINT_SERVICE) as PrintManager</span><br><span class="line">       var myPrintAdapter = MyPrintPdfAdapter(filePath)</span><br><span class="line">       printManager.print(&quot;jobName&quot;, myPrintAdapter, null)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>打印 word 文件</p>
</blockquote>
<p>因为 Android 提供的打印服务无法直接打印 word 文件，因此，我们需要将 word 文件转化为 html 文件或者是 pdf 文件之后， 再进行打印操作。</p>
<p>我采用的方法是利用 poi 将 word 文件转化成 html 文件， 然后通过 webView 进行加载后打印， 下面附上一部分关键的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line">* 自定义的 word 的生成类， 支持插入标题，图片，表格等，需要自定义 XWPFDocument</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">public class WordGenerate &#123;</span><br><span class="line"></span><br><span class="line">    private WeakReference&lt;Context&gt; mContex;</span><br><span class="line">    private static volatile WordGenerate instance;</span><br><span class="line">    private CustomXWPFDocument customXWPFDocument;</span><br><span class="line">    private OutputStream os;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private WordGenerate(Context context) &#123;</span><br><span class="line">        mContex = new WeakReference&lt;&gt;(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static WordGenerate newInstance(Context context) &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            synchronized (WordGenerate.class) &#123;</span><br><span class="line">                if (instance == null) &#123;</span><br><span class="line">                    instance = new WordGenerate(context);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private File word;</span><br><span class="line">    private CustomXWPFDocument xwpfDocument;</span><br><span class="line"></span><br><span class="line">    public WordGenerate newWordFile(String name) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String path = mContex.get().getFilesDir() + File.separator + name + &quot;.docx&quot;;</span><br><span class="line">            word = new File(path);</span><br><span class="line">            os = new FileOutputStream(word);</span><br><span class="line">            xwpfDocument = new CustomXWPFDocument();</span><br><span class="line">            PackagePart pp = xwpfDocument.createStyles().getPackagePart();</span><br><span class="line">            xwpfDocument.getPackagePart().addRelationship(pp.getPartName(), TargetMode.INTERNAL, pp.getContentType());</span><br><span class="line">            xwpfDocument.getDocument().getBody().addNewSectPr();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public WordGenerate insertTitle(String title) &#123;</span><br><span class="line">        if (xwpfDocument == null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Invole Method newWordFile() First&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        createWord(ParagraphAlignment.CENTER, 20, true, title);</span><br><span class="line">        return this;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public WordGenerate insertWord(ParagraphAlignment align, int fontSize, boolean bold, String word) &#123;</span><br><span class="line">        if (xwpfDocument == null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Invole Method newWordFile() First&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        createWord(align, fontSize, bold, word);</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public WordGenerate insertPicture(FileInputStream inputStream) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (xwpfDocument == null) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;Invole Method newWordFile() First&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            byte[] ba = new byte[inputStream.available()];</span><br><span class="line">            inputStream.read(ba);</span><br><span class="line">            ByteArrayInputStream byteInputStream = new ByteArrayInputStream(ba);</span><br><span class="line">            XWPFParagraph picture = xwpfDocument.createParagraph();</span><br><span class="line">//            添加图片</span><br><span class="line">            xwpfDocument.addPictureData(byteInputStream, CustomXWPFDocument.PICTURE_TYPE_JPEG);</span><br><span class="line">            xwpfDocument.createPicture(xwpfDocument.getAllPictures().size() - 1, 100, 100, picture);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return this;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public WordGenerate insertExcel(String[][] excelData) &#123;</span><br><span class="line">        if (xwpfDocument == null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Invole Method newWordFile() First&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (excelData.length == 0) &#123;</span><br><span class="line">            Log.e(&quot;PrintByWifi&quot;, &quot;excelData&apos;s size is 0&quot;);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line">        XWPFTable table = xwpfDocument.createTable(excelData.length, excelData[0].length);</span><br><span class="line">        CTTbl ttbl = table.getCTTbl();</span><br><span class="line">        CTTblPr tblPr = ttbl.getTblPr() == null ? ttbl.addNewTblPr() : ttbl.getTblPr();</span><br><span class="line">        CTTblBorders borders = tblPr.isSetTblBorders() ? tblPr.getTblBorders(): tblPr.addNewTblBorders();</span><br><span class="line"></span><br><span class="line">        ttbl.addNewTblGrid();</span><br><span class="line">        for (int i = 0; i &lt; table.getRows().size(); i++) &#123;</span><br><span class="line">            XWPFTableRow row = table.getRow(i);</span><br><span class="line">            for (int j = 0; j &lt; row.getTableCells().size(); j++) &#123;</span><br><span class="line">                XWPFTableCell cell = row.getCell(j);</span><br><span class="line">                CTTc cttc = cell.getCTTc();</span><br><span class="line">                CTTcPr cellPr = cttc.isSetTcPr() ? cttc.getTcPr() : cttc.addNewTcPr();</span><br><span class="line">                cellPr.addNewTcW();</span><br><span class="line">                cellPr.getTcW();</span><br><span class="line">                cellPr.addNewVAlign().setVal(STVerticalJc.CENTER);</span><br><span class="line">                if (i == 0) &#123;</span><br><span class="line">                    cttc.getPList().get(0).addNewPPr().addNewJc().setVal(STJc.CENTER);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    cttc.getPList().get(0).addNewPPr().addNewJc().setVal(STJc.RIGHT);</span><br><span class="line">                &#125;</span><br><span class="line">                CTTblWidth tblWidth1 = cellPr.isSetTcW() ? cellPr.getTcW() : cellPr.addNewTcW();</span><br><span class="line">                tblWidth1.setW(new BigInteger(&quot;800&quot;));</span><br><span class="line">                tblWidth1.setType(STTblWidth.DXA);</span><br><span class="line">                cell.setText(excelData[i][j]);</span><br><span class="line">                XWPFParagraph paragraph = cell.addParagraph();</span><br><span class="line">                XWPFRun run = paragraph.createRun();</span><br><span class="line">                run.setText(excelData[i][j]);</span><br><span class="line"></span><br><span class="line">                ((XWPFParagraph)cell.getBodyElements().get(0)).addRun(run);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String generate() &#123;</span><br><span class="line">        String dst = &quot;&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (xwpfDocument == null) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;Invole Method newWordFile() First&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            xwpfDocument.write(os);</span><br><span class="line">            os.flush();</span><br><span class="line">            os.close();</span><br><span class="line">            dst =  mContex.get().getFilesDir() + File.separator + &quot;test.html&quot;;</span><br><span class="line">//            WordToPdf.docxToPdf(xwpfDocument, dst);</span><br><span class="line">            WordToPdf.docx2Html(mContex.get(),  xwpfDocument, dst);</span><br><span class="line"></span><br><span class="line">            return dst;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return dst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 生成文字</span><br><span class="line">     *</span><br><span class="line">     * @param align    文字的位置 CENTER LEFT RIGHT</span><br><span class="line">     * @param fontSize 文字的大小</span><br><span class="line">     * @param bold     文字是否加粗</span><br><span class="line">     * @param message  文字的内容</span><br><span class="line">     */</span><br><span class="line">    private void createWord(ParagraphAlignment align, int fontSize, boolean bold, String message) &#123;</span><br><span class="line">        XWPFParagraph titleParagraph = xwpfDocument.createParagraph();</span><br><span class="line">        titleParagraph.setAlignment(align);</span><br><span class="line">        XWPFRun titleRun = titleParagraph.createRun();</span><br><span class="line">        titleRun.setText(message);</span><br><span class="line">        titleRun.setFontSize(fontSize);</span><br><span class="line">        titleRun.setFontFamily(&quot;宋体&quot;);</span><br><span class="line">        titleRun.setBold(bold);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class CustomXWPFDocument extends XWPFDocument &#123;</span><br><span class="line">	public CustomXWPFDocument(InputStream in) throws IOException &#123;</span><br><span class="line">		super(in);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public CustomXWPFDocument() &#123;</span><br><span class="line">		super();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public CustomXWPFDocument(OPCPackage pkg) throws IOException &#123;</span><br><span class="line">		super(pkg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * @param id</span><br><span class="line">	 * @param width</span><br><span class="line">	 *            宽</span><br><span class="line">	 * @param height</span><br><span class="line">	 *            高</span><br><span class="line">	 * @param paragraph</span><br><span class="line">	 *            段落</span><br><span class="line">	 */</span><br><span class="line">	public void createPicture(int id, int width, int height,</span><br><span class="line">			XWPFParagraph paragraph) &#123;</span><br><span class="line">		final int EMU = 9525;</span><br><span class="line">		width *= EMU;</span><br><span class="line">		height *= EMU;</span><br><span class="line">		String blipId = getAllPictures().get(id).getPackageRelationship()</span><br><span class="line">				.getId();</span><br><span class="line">		CTInline inline = paragraph.createRun().getCTR().addNewDrawing()</span><br><span class="line">				.addNewInline();</span><br><span class="line">		String picXml = &quot;&quot;</span><br><span class="line">				+ &quot;&lt;a:graphic xmlns:a=\&quot;http://schemas.openxmlformats.org/drawingml/2006/main\&quot;&gt;&quot;</span><br><span class="line">				+ &quot;   &lt;a:graphicData uri=\&quot;http://schemas.openxmlformats.org/drawingml/2006/picture\&quot;&gt;&quot;</span><br><span class="line">				+ &quot;      &lt;pic:pic xmlns:pic=\&quot;http://schemas.openxmlformats.org/drawingml/2006/picture\&quot;&gt;&quot;</span><br><span class="line">				+ &quot;         &lt;pic:nvPicPr&gt;&quot; + &quot;            &lt;pic:cNvPr id=\&quot;&quot;</span><br><span class="line">				+ id</span><br><span class="line">				+ &quot;\&quot; name=\&quot;Generated\&quot;/&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;pic:cNvPicPr/&gt;&quot;</span><br><span class="line">				+ &quot;         &lt;/pic:nvPicPr&gt;&quot;</span><br><span class="line">				+ &quot;         &lt;pic:blipFill&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;a:blip r:embed=\&quot;&quot;</span><br><span class="line">				+ blipId</span><br><span class="line">				+ &quot;\&quot; xmlns:r=\&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships\&quot;/&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;a:stretch&gt;&quot;</span><br><span class="line">				+ &quot;               &lt;a:fillRect/&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;/a:stretch&gt;&quot;</span><br><span class="line">				+ &quot;         &lt;/pic:blipFill&gt;&quot;</span><br><span class="line">				+ &quot;         &lt;pic:spPr&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;a:xfrm&gt;&quot;</span><br><span class="line">				+ &quot;               &lt;a:off x=\&quot;0\&quot; y=\&quot;0\&quot;/&gt;&quot;</span><br><span class="line">				+ &quot;               &lt;a:ext cx=\&quot;&quot;</span><br><span class="line">				+ width</span><br><span class="line">				+ &quot;\&quot; cy=\&quot;&quot;</span><br><span class="line">				+ height</span><br><span class="line">				+ &quot;\&quot;/&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;/a:xfrm&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;a:prstGeom prst=\&quot;rect\&quot;&gt;&quot;</span><br><span class="line">				+ &quot;               &lt;a:avLst/&gt;&quot;</span><br><span class="line">				+ &quot;            &lt;/a:prstGeom&gt;&quot;</span><br><span class="line">				+ &quot;         &lt;/pic:spPr&gt;&quot;</span><br><span class="line">				+ &quot;      &lt;/pic:pic&gt;&quot;</span><br><span class="line">				+ &quot;   &lt;/a:graphicData&gt;&quot; + &quot;&lt;/a:graphic&gt;&quot;;</span><br><span class="line"></span><br><span class="line">		inline.addNewGraphic().addNewGraphicData();</span><br><span class="line">		XmlToken xmlToken = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			xmlToken = XmlToken.Factory.parse(picXml);</span><br><span class="line">		&#125; catch (XmlException xe) &#123;</span><br><span class="line">			xe.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		inline.set(xmlToken);</span><br><span class="line"></span><br><span class="line">		inline.setDistT(0);</span><br><span class="line">		inline.setDistB(0);</span><br><span class="line">		inline.setDistL(0);</span><br><span class="line">		inline.setDistR(0);</span><br><span class="line"></span><br><span class="line">		CTPositiveSize2D extent = inline.addNewExtent();</span><br><span class="line">		extent.setCx(width);</span><br><span class="line">		extent.setCy(height);</span><br><span class="line"></span><br><span class="line">		CTNonVisualDrawingProps docPr = inline.addNewDocPr();</span><br><span class="line">		docPr.setId(id);</span><br><span class="line">		docPr.setName(&quot;图片名称&quot;);</span><br><span class="line">		docPr.setDescr(&quot;描述信息&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* word 转换为 html 类</span><br><span class="line">*/</span><br><span class="line">public class WordToHtml&#123;</span><br><span class="line"></span><br><span class="line">    public static void docx2Html(Context mContext, XWPFDocument document, String outPutFile) throws IOException &#123;</span><br><span class="line">        String fileOutName = outPutFile;</span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        XHTMLOptions options = XHTMLOptions.create().indent(4);</span><br><span class="line">        // 导出图片</span><br><span class="line">        File imageFolder = new File(mContext.getFilesDir() + File.separator + &quot;images&quot;);</span><br><span class="line">        options.setExtractor(new FileImageExtractor(imageFolder));</span><br><span class="line">        // URI resolver  word的html中图片的目录路径</span><br><span class="line">        options.URIResolver(new BasicURIResolver(&quot;images&quot;));</span><br><span class="line">        File outFile = new File(fileOutName);</span><br><span class="line">        outFile.getParentFile().mkdirs();</span><br><span class="line">        OutputStream out = new FileOutputStream(outFile);</span><br><span class="line">        XHTMLConverter.getInstance().convert(document, out, options);</span><br><span class="line">        System.out.println(&quot;Generate &quot; + fileOutName + &quot; with &quot; + (System.currentTimeMillis() - startTime) + &quot; ms.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* word 打印</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">fun printWord() &#123;</span><br><span class="line"></span><br><span class="line">		    var file: File = File(&quot;$&#123;filesDir&#125;$&#123;File.separator&#125;test.png&quot;)</span><br><span class="line">               var os = FileOutputStream(file)</span><br><span class="line">               var inputStream = assets.open(&quot;app_image_small.png&quot;);</span><br><span class="line">               var bts = ByteArray(1024)</span><br><span class="line">               var len = inputStream.read(bts)</span><br><span class="line">               while (len != -1) &#123;</span><br><span class="line">                   os.write(bts, 0, len)</span><br><span class="line">                   os.flush()</span><br><span class="line">                   len = inputStream.read(bts)</span><br><span class="line">               &#125;</span><br><span class="line">               var path = WordGenerate.newInstance(this).newWordFile(&quot;test&quot;).insertTitle(&quot;这是一个测试的 Word&quot;)</span><br><span class="line">                       .insertWord(ParagraphAlignment.LEFT, 16, false, &quot;测试测试，好开心好开心xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;)</span><br><span class="line">                       .insertPicture(FileInputStream(file))</span><br><span class="line">                       .insertExcel(data)</span><br><span class="line">                       .generate()</span><br><span class="line">               PrintService.instance.printWord(this@MainActivity, path)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>想要打印相关源码的朋友戳这里：<a href="https://github.com/LakeMirror/printByWifi/tree/master" target="_blank" rel="noopener">PrintByWifi</a>;</p>
<h5>总结</h5>

<p>wifi 打印本文章主要是在 Android 提供的打印基础上进行的开发， 本文章中基本满足打印的大部分需求。<br>打印 html、 pdf、 bitmap 功能很简单，但在实现打印 word 文档的过程中，遇到了不少的问题，主要的就是 poi 在 java 中能够很好的支持， 但是在 android 使用的话可能会存在一些问题， 因此， 使用的依赖包的版本必须要对应，不能随意搭配，还要就是 word 转 html 的时候，可能你自己生成的 word 文件看着毫无破绽，但是在转换的过程中， 却会出现各种奇葩的空指针异常，这个主要体现在表格的转换上，这个通过深入 XMTLConverter 代码，磕磕绊绊的总算实现了。</p>
<p>欢迎有疑问的小伙伴留言讨论。</p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/octoberqin">
                            <span class="fa-stack fa-lg">
                                 <i class="iconfont icon-zhihu"></i>
                            </span>
            </a>
        </li>
        

        

        

        
        <li>
            <a target="_blank" href="https://github.com/lakeMirror">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://blogoflakemirror.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>



</html>
